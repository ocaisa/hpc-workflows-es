<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="es" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>HPC Workflow Management with Snakemake: Todo en una sola página</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png">
<link rel="manifest" href="../favicons/incubator/site.webmanifest">
<link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Ir al contenido principal</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="Esta lección se encuentra en la fase pre-alfa, lo que significa que está en las primeras etapas de desarrollo, pero aún no se ha enseñado.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alfa
            </a>
            <span class="visually-hidden">Esta lección se encuentra en la fase pre-alfa, lo que significa que está en las primeras etapas de desarrollo, pero aún no se ha enseñado.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Vista de la instructora <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Vista de estudiante</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Navegación principal"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Alternar navegación">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menú</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      HPC Workflow Management with Snakemake
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Buscar en la página All In One" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            HPC Workflow Management with Snakemake
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Puntos Clave</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Notas de la instructora</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extraer todas las imágenes</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Más <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<hr>
<li><a class="dropdown-item" href="reference.html">Referencia</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Buscar en la página All In One"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Buscar en la página All In One">Buscar en la página All In One</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  HPC Workflow Management with Snakemake
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Progreso de la lección" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="Cerrar menú" alt="Cerrar menú" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Cerrar " data-episodes="Episodios ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Vista de la instructora
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Vista de estudiante</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODIOS
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Resumen y agenda</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Ejecutando comandos con Snakemake</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-snakemake_on_the_cluster.html">2. Ejecutando Snakemake en el cluster</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-placeholders.html">3. Marcadores de posición</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-snakemake_and_mpi.html">4. Aplicaciones MPI y Snakemake</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-chaining_rules.html">5. Encadenamiento de reglas</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-expansion.html">6. Procesamiento de listas de entradas</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RECURSOS
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Puntos Clave</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Notas de la instructora</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extraer todas las imágenes</a>
                      </li>
                      <hr>
<li><a class="dropdown-item" href="reference.html">Referencia</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="../instructor/aio.html">Todo en una sola página</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-introduction"><p>Content from <a href="01-introduction.html">Ejecutando comandos con Snakemake</a></p>
<hr>
<p>Última actualización: 2024-11-25 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/01-introduction.md" class="external-link">Mejora esta página <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Tiempo estimado: <i aria-hidden="true" data-feather="clock"></i> 60 minutos</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Mostrar todas las soluciones " data-collapse="Cerrar todas las soluciones "> Mostrar todas las soluciones <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Hoja de ruta</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Preguntas</h3>
<ul>
<li>“¿Cómo ejecuto un comando simple con Snakemake?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objetivos</h3>
<ul>
<li>“Crea una receta de Snakemake (un Snakefile)”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="cuál-es-el-flujo-de-trabajo-que-me-interesa">¿Cuál es el flujo de trabajo que me interesa?<a class="anchor" aria-label="anchor" href="#cu%C3%A1l-es-el-flujo-de-trabajo-que-me-interesa"></a>
</h2>
<hr class="half-width">
<p>En esta lección haremos un experimento que toma una aplicación que
corre en paralelo e investigará su escalabilidad. Para ello
necesitaremos recopilar datos, en este caso eso significa ejecutar la
aplicación varias veces con diferentes números de núcleos de CPU y
registrar el tiempo de ejecución. Una vez hecho esto, tenemos que crear
una visualización de los datos para ver cómo se compara con el caso
ideal.</p>
<p>A partir de la visualización podemos decidir a qué escala tiene más
sentido ejecutar la aplicación en producción para maximizar el uso de
nuestra asignación de CPU en el sistema.</p>
<p>Podríamos hacer todo esto manualmente, pero existen herramientas
útiles que nos ayudan a gestionar pipelines de análisis de datos como el
que tenemos en nuestro experimento. Hoy vamos a aprender acerca de uno
de ellos: Snakemake.</p>
<p>Con el fin de empezar con Snakemake, vamos a empezar por tomar un
comando simple y ver cómo podemos ejecutar que a través de Snakemake.
Elijamos el comando <code>hostname</code> que imprime el nombre del host
donde se ejecuta el comando:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ hostname</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">node1.int.jetstream2.hpc</span><span class="op">-</span><span class="va">carpentry.org</span></span></code></pre>
</div>
<p>Eso imprime el resultado pero Snakemake se basa en archivos para
conocer el estado de su flujo de trabajo, así que vamos a redirigir la
salida a un archivo:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ hostname <span class="op">&gt;</span> hostname_login.txt</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="creando-un-archivo-snakefile">Creando un archivo Snakefile<a class="anchor" aria-label="anchor" href="#creando-un-archivo-snakefile"></a>
</h2>
<hr class="half-width">
<p>Edita un nuevo archivo de texto llamado <code>Snakefile</code>.</p>
<p>Contenido de <code>Snakefile</code>:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>rule hostname_login:</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    output: <span class="st">"hostname_login.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="bu">input</span>:  </span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    shell:</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_login.txt"</span></span></code></pre>
</div>
<div id="puntos-clave-sobre-este-archivo" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="puntos-clave-sobre-este-archivo" class="callout-inner">
<h3 class="callout-title">Puntos clave sobre este archivo</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>El archivo se llama <code>Snakefile</code> - con mayúscula
<code>S</code> y sin extensión de archivo.</li>
<li>Algunas líneas tienen sangría. Las sangrías deben ser con caracteres
de espacio, no tabuladores. Vea la sección de configuración para saber
cómo hacer que su editor de texto haga esto.</li>
<li>La definición de la regla comienza con la palabra clave
<code>rule</code> seguida por el nombre de la regla, luego dos
puntos.</li>
<li>Llamamos a la regla <code>hostname_login</code>. Puede utilizar
letras, números o guiones bajos, pero el nombre de la regla debe
comenzar con una letra y no puede ser una palabra clave.</li>
<li>Las palabras clave <code>input</code>, <code>output</code>, y
<code>shell</code> van todas seguidas de dos puntos (“:”).</li>
<li>Los nombres de los archivos y el comando shell están todos en
<code>"quotes"</code>.</li>
<li>El nombre del archivo de salida se da antes del nombre del archivo
de entrada. De hecho, a Snakemake no le importa en qué orden aparecen,
pero en este curso daremos primero el de salida. Pronto veremos por
qué.</li>
<li>En este caso de uso no hay fichero de entrada para el comando por lo
que lo dejamos en blanco.</li>
</ol>
</div>
</div>
</div>
<p>De vuelta en el shell ejecutaremos nuestra nueva regla. En este
punto, si faltaran comillas, sangrías incorrectas, etc., podríamos ver
un error.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-j1</span> <span class="at">-p</span> hostname_login</span></code></pre>
</div>
<div id="bash-snakemake-command-not-found..." class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="bash-snakemake-command-not-found..." class="callout-inner">
<h3 class="callout-title"><code>bash: snakemake: command not found...</code></h3>
<div class="callout-content">
<p>Si tu shell te dice que no puede encontrar el comando
<code>snakemake</code> entonces tenemos que hacer que el software esté
disponible de alguna manera. En nuestro caso, esto significa buscar el
módulo que necesitamos cargar:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">module</span> spider snakemake</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[ocaisa@node1 ~]$ module spider snakemake

--------------------------------------------------------------------------------------------------------
  snakemake:
--------------------------------------------------------------------------------------------------------
     Versions:
        snakemake/8.2.1-foss-2023a
        snakemake/8.2.1 (E)

Names marked by a trailing (E) are extensions provided by another module.


--------------------------------------------------------------------------------------------------------
  For detailed information about a specific "snakemake" package (including how to load the modules) use the module's full name.
  Note that names that have a trailing (E) are extensions provided by other modules.
  For example:

     $ module spider snakemake/8.2.1
--------------------------------------------------------------------------------------------------------</code></pre>
</div>
<p>Ahora queremos el módulo, así que vamos a cargarlo para que el
paquete esté disponible</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ module load snakemake</span></code></pre>
</div>
<p>y luego asegúrate de que tenemos el comando <code>snakemake</code>
disponible</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ which snakemake</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/cvmfs/software.eessi.io/host_injections/2023.06/software/linux/x86_64/amd/zen3/software/snakemake/8.2.1-foss-2023a/bin/snakemake</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-j1</span> <span class="at">-p</span> hostname_login</span></code></pre>
</div>
</div>
</div>
</div>
<div id="ejecutando-snakemake" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="ejecutando-snakemake" class="callout-inner">
<h3 class="callout-title">Ejecutando Snakemake</h3>
<div class="callout-content">
<p>Ejecute <code>snakemake --help | less</code> para ver la ayuda de
todas las opciones disponibles. ¿Qué hace la opción <code>-p</code> en
el comando <code>snakemake</code> anterior?</p>
<ol style="list-style-type: decimal">
<li>Protege los archivos de salida existentes</li>
<li>Imprime en el terminal los comandos shell que se están
ejecutando</li>
<li>Le dice a Snakemake que sólo ejecute un proceso a la vez</li>
<li>Solicita al usuario el fichero de entrada correcto</li>
</ol>
</div>
</div>
</div>
<div id="accordionHint1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button hint-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHint1" aria-expanded="false" aria-controls="collapseHint1">
  <h4 class="accordion-header" id="headingHint1"> Dar una pista </h4>
</button>
<div id="collapseHint1" class="accordion-collapse collapse" data-bs-parent="#accordionHint1" aria-labelledby="headingHint1">
<div class="accordion-body">
<p>Puedes buscar en el texto pulsando <kbd>/</kbd>, y salir de nuevo al
shell con <kbd>q</kbd>.</p>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Mostrar la solución </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<ol start="2" style="list-style-type: decimal">
<li>Imprime en el terminal los comandos shell que se están
ejecutando</li>
</ol>
<p>¡Esto es tan útil que no sabemos por qué no está por defecto! La
opción <code>-j1</code> es lo que le dice a Snakemake que sólo ejecute
un proceso a la vez, y nos quedaremos con esto por ahora ya que hace las
cosas más simples. La respuesta 4 es una pista falsa, ya que Snakemake
nunca solicita interactivamente la entrada del usuario.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Puntos Clave</h3>
<div class="callout-content">
<ul>
<li>“Antes de ejecutar Snakemake necesitas escribir un Snakefile”</li>
<li>“Un Snakefile es un archivo de texto que define una lista de
reglas”</li>
<li>“Las reglas tienen entradas, salidas y comandos de shell a
ejecutar”</li>
<li>“Le dices a Snakemake qué archivo hacer y ejecutará el comando shell
definido en la regla apropiada”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-02-snakemake_on_the_cluster"><p>Content from <a href="02-snakemake_on_the_cluster.html">Ejecutando Snakemake en el cluster</a></p>
<hr>
<p>Última actualización: 2024-11-25 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/02-snakemake_on_the_cluster.md" class="external-link">Mejora esta página <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Tiempo estimado: <i aria-hidden="true" data-feather="clock"></i> 50 minutos</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Mostrar todas las soluciones " data-collapse="Cerrar todas las soluciones "> Mostrar todas las soluciones <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Hoja de ruta</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Preguntas</h3>
<ul>
<li>“¿Cómo ejecuto mi regla de Snakemake en el cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objetivos</h3>
<ul>
<li>“Define reglas para ejecutar localmente y en el cluster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>¿Qué ocurre cuando queremos que nuestra regla se ejecute en el
cluster en lugar de en el nodo de inicio de sesión? El cluster que
estamos usando utiliza Slurm, y sucede que Snakemake tiene soporte
integrado para Slurm, solo necesitamos decirle que queremos usarlo.</p>
<p>Snakemake utiliza la opción <code>executor</code> para permitirte
seleccionar el plugin que deseas que ejecute la regla. La forma más
rápida de aplicar esto a tu Snakefile es definirlo en la línea de
comandos. Vamos a probarlo</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">-j1</span> <span class="at">-p</span> <span class="at">--executor</span> slurm hostname_login</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Retrieving input from storage.
Nothing to be done (all requested files are present and up to date).</code></pre>
</div>
<p>¡No ha pasado nada! ¿Por qué? Cuando se le pide que construya un
objetivo, Snakemake comprueba la ‘última hora de modificación’ tanto del
objetivo como de sus dependencias. Si alguna dependencia ha sido
actualizada desde el objetivo, entonces las acciones se vuelven a
ejecutar para actualizar el objetivo. Usando este enfoque, Snakemake
sabe que sólo debe reconstruir los archivos que, directa o
indirectamente, dependen del archivo que cambió. Esto se llama una
<em>construcción incremental</em>.</p>
<div id="las-construcciones-incrementales-mejoran-la-eficiencia" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="las-construcciones-incrementales-mejoran-la-eficiencia" class="callout-inner">
<h3 class="callout-title">Las construcciones incrementales mejoran la eficiencia</h3>
<div class="callout-content">
<p>Al reconstruir los archivos sólo cuando es necesario, Snakemake hace
que su procesamiento sea más eficiente.</p>
</div>
</div>
</div>
<div id="ejecutando-en-el-cluster" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="ejecutando-en-el-cluster" class="callout-inner">
<h3 class="callout-title">Ejecutando en el cluster</h3>
<div class="callout-content">
<p>Ahora necesitamos otra regla que ejecute el <code>hostname</code> en
el <em>cluster</em>. Crea una nueva regla en tu Snakefile e intenta
ejecutarla en el cluster con la opción <code>--executor slurm</code> a
<code>snakemake</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Mostrar la solución </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>La regla es casi idéntica a la regla anterior excepto por el nombre
de la regla y el archivo de salida:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    shell:</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_remote.txt"</span></span></code></pre>
</div>
<p>A continuación, puede ejecutar la regla con</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">-j1</span> <span class="at">-p</span> <span class="at">--executor</span> slurm hostname_remote</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Retrieving input from storage.
Using shell: /cvmfs/software.eessi.io/versions/2023.06/compat/linux/x86_64/bin/bash
Provided remote nodes: 1
Job stats:
job                count
---------------  -------
hostname_remote        1
total                  1

Select jobs to execute...
Execute 1 jobs...

[Mon Jan 29 18:03:46 2024]
rule hostname_remote:
    output: hostname_remote.txt
    jobid: 0
    reason: Missing output files: hostname_remote.txt
    resources: tmpdir=&lt;TBD&gt;

hostname &gt; hostname_remote.txt
No SLURM account given, trying to guess.
Guessed SLURM account: def-users
No wall time information given. This might or might not work on your cluster.
If not, specify the resource runtime in your rule or as a reasonable default
via --default-resources. No job memory information ('mem_mb' or
'mem_mb_per_cpu') is given - submitting without.
This might or might not work on your cluster.
Job 0 has been submitted with SLURM jobid 326 (log: /home/ocaisa/.snakemake/slurm_logs/rule_hostname_remote/326.log).
[Mon Jan 29 18:04:26 2024]
Finished job 0.
1 of 1 steps (100%) done
Complete log: .snakemake/log/2024-01-29T180346.788174.snakemake.log</code></pre>
</div>
<p>Observe todas las advertencias que Snakemake nos está dando sobre el
hecho de que la regla puede no ser capaz de ejecutarse en nuestro
cluster ya que puede que no hayamos dado suficiente información. Por
suerte para nosotros, esto funciona en nuestro cluster y podemos echar
un vistazo al archivo de salida que crea la nueva regla,
<code>hostname_remote.txt</code>:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ cat hostname_remote.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">tmpnode1.int.jetstream2.hpc</span><span class="op">-</span><span class="va">carpentry.org</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="perfil-de-snakemake">Perfil de Snakemake<a class="anchor" aria-label="anchor" href="#perfil-de-snakemake"></a>
</h2>
<hr class="half-width">
<p>Adaptar Snakemake a un entorno particular puede implicar muchas
banderas y opciones. Por lo tanto, es posible especificar un perfil de
configuración que se utilizará para obtener las opciones por defecto.
Esto se parece a</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> myprofileFolder ...</span></code></pre>
</div>
<p>La carpeta del perfil debe contener un archivo llamado
<code>config.yaml</code> que es el que almacenará nuestras opciones. La
carpeta también puede contener otros archivos necesarios para el perfil.
Vamos a crear el archivo <code>cluster_profile/config.yaml</code> e
insertar algunas de nuestras opciones existentes:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span></code></pre>
</div>
<p>Ahora debemos ser capaces de volver a ejecutar nuestro flujo de
trabajo apuntando al perfil en lugar de la lista de las opciones. Para
obligar a nuestro flujo de trabajo a volver a ejecutarse, primero
tenemos que eliminar el archivo de salida
<code>hostname_remote.txt</code>, y luego podemos probar nuestro nuevo
perfil</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ rm hostname_remote.txt</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">--profile</span> cluster_profile hostname_remote</span></code></pre>
</div>
<p>El perfil es extremadamente útil en el contexto de nuestro cluster,
ya que el ejecutor Slurm tiene muchas opciones, y a veces necesitas
usarlas para poder enviar trabajos al cluster al que tienes acceso.
Desafortunadamente, los nombres de las opciones en Snakemake no son
<em>exactamente</em> los mismos que los de Slurm, por lo que necesitamos
la ayuda de una tabla de traducción:</p>
<table class="table">
<colgroup>
<col width="17%">
<col width="17%">
<col width="64%">
</colgroup>
<thead><tr class="header">
<th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>--partition</code></td>
<td><code>slurm_partition</code></td>
<td>the partition a rule/job is to use</td>
</tr>
<tr class="even">
<td><code>--time</code></td>
<td><code>runtime</code></td>
<td>the walltime per job in minutes</td>
</tr>
<tr class="odd">
<td><code>--constraint</code></td>
<td><code>constraint</code></td>
<td>may hold features on some clusters</td>
</tr>
<tr class="even">
<td><code>--mem</code></td>
<td><code>mem, mem_mb</code></td>
<td>memory a cluster node must</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>provide (mem: string with unit), mem_mb: int</td>
</tr>
<tr class="even">
<td><code>--mem-per-cpu</code></td>
<td><code>mem_mb_per_cpu</code></td>
<td>memory per reserved CPU</td>
</tr>
<tr class="odd">
<td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr>
<tr class="even">
<td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr>
<tr class="odd">
<td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr>
</tbody>
</table>
<p>Las advertencias dadas por Snakemake dieron a entender que podríamos
necesitar proporcionar estas opciones. Una forma de hacerlo es
proporcionarlas como parte de la regla de Snakemake utilizando la
palabra clave <code>resources</code>, por ejemplo,</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>rule:</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    <span class="bu">input</span>: ...</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    output: ...</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    resources:</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>        partition: <span class="op">&lt;</span>partition name<span class="op">&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>        runtime: <span class="op">&lt;</span>some number<span class="op">&gt;</span></span></code></pre>
</div>
<p>y también podemos usar el perfil para definir valores por defecto
para estas opciones para usar con nuestro proyecto, usando la palabra
clave <code>default-resources</code>. Por ejemplo, la memoria disponible
en nuestro cluster es de unos 4GB por núcleo, así que podemos añadir eso
a nuestro perfil:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>Sabemos que nuestro problema se ejecuta en muy poco tiempo. Cambia la
duración por defecto de nuestros trabajos a dos minutos para Slurm.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Mostrar la solución </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Existen varias opciones <code>sbatch</code> no soportadas
directamente por las definiciones de recursos de la tabla anterior.
Puede utilizar el recurso <code>slurm_extra</code> para especificar
cualquiera de estas opciones adicionales a <code>sbatch</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>rule myrule:</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    <span class="bu">input</span>: ...</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    output: ...</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    resources:</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>        slurm_extra<span class="op">=</span><span class="st">"--mail-type=ALL --mail-user=&lt;your email&gt;"</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="ejecución-local-de-reglas">Ejecución local de reglas<a class="anchor" aria-label="anchor" href="#ejecuci%C3%B3n-local-de-reglas"></a>
</h2>
<hr class="half-width">
<p>Nuestra regla inicial era obtener el nombre de host del nodo de
inicio de sesión. Siempre queremos ejecutar esa regla en el nodo de
inicio de sesión para que tenga sentido. Si le decimos a Snakemake que
ejecute todas las reglas a través del ejecutor Slurm (que es lo que
estamos haciendo a través de nuestro nuevo perfil) esto ya no sucederá.
Entonces, ¿cómo forzamos la regla para que se ejecute en el nodo de
inicio de sesión?</p>
<p>Bueno, en el caso de que una regla de Snakemake realice una tarea
trivial, el envío de trabajos podría ser excesivo (por ejemplo, menos de
1 minuto de tiempo de computación). Similar a nuestro caso, sería una
mejor idea hacer que estas reglas se ejecuten localmente (es decir,
donde se ejecuta el comando <code>snakemake</code>) en lugar de como un
trabajo. Snakemake le permite indicar qué reglas deben ejecutarse
siempre localmente con la palabra clave <code>localrules</code>. Vamos a
definir <code>hostname_login</code> como una regla local cerca de la
parte superior de nuestro <code>Snakefile</code>.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>localrules: hostname_login</span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Puntos Clave</h3>
<div class="callout-content">
<ul>
<li>“Snakemake genera y envía sus propios scripts por lotes para su
planificador.”</li>
<li>“Puedes almacenar parámetros de configuración por defecto en un
perfil de Snakemake”</li>
<li>“<code>localrules</code> define reglas que son ejecutadas
localmente, y nunca enviadas a un cluster.”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-03-placeholders"><p>Content from <a href="03-placeholders.html">Marcadores de posición</a></p>
<hr>
<p>Última actualización: 2024-11-25 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/03-placeholders.md" class="external-link">Mejora esta página <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Tiempo estimado: <i aria-hidden="true" data-feather="clock"></i> 70 minutos</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Mostrar todas las soluciones " data-collapse="Cerrar todas las soluciones "> Mostrar todas las soluciones <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Hoja de ruta</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Preguntas</h3>
<ul>
<li>“¿Cómo hago una regla genérica?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objetivos</h3>
<ul>
<li>“Mira cómo Snakemake trata algunos errores”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Nuestro Snakefile tiene algunos duplicados. Por ejemplo, los nombres
de los archivos de texto se repiten en algunos lugares a lo largo de las
reglas del Snakefile. Los Snakefiles son una forma de código y, en
cualquier código, la repetición puede dar lugar a problemas (por
ejemplo, renombramos un archivo de datos en una parte del Snakefile pero
olvidamos renombrarlo en otro lugar).</p>
<div id="d.r.y.-dont-repeat-yourself-no-te-repitas" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="d.r.y.-dont-repeat-yourself-no-te-repitas" class="callout-inner">
<h3 class="callout-title">D.R.Y. (Don’t Repeat Yourself) (No te repitas)</h3>
<div class="callout-content">
<p>En muchos lenguajes de programación, la mayor parte de las
características del lenguaje están ahí para permitir al programador
describir rutinas computacionales largas como código corto, expresivo y
bonito. Las características de Python, R o Java, como las variables y
funciones definidas por el usuario, son útiles en parte porque nos
evitan tener que escribir (o pensar) en todos los detalles una y otra
vez. Este buen hábito de escribir las cosas sólo una vez se conoce como
el principio de “No te repitas” o D.R.Y. (por sus siglas en inglés).</p>
</div>
</div>
</div>
<p>Vamos a eliminar algunas de las repeticiones de nuestro archivo
Snakefile.</p>
<section><h2 class="section-heading" id="marcadores-de-posición">Marcadores de posición<a class="anchor" aria-label="anchor" href="#marcadores-de-posici%C3%B3n"></a>
</h2>
<hr class="half-width">
<p>Para hacer una regla más genérica necesitamos <strong>marcadores de
posición</strong>. Veamos qué aspecto tiene un marcador de posición</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    shell:</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>        <span class="co">"hostname &gt; {output}"</span></span></code></pre>
</div>
<p>Como recordatorio, aquí está la versión anterior del último
episodio:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_remote.txt"</span></span></code></pre>
</div>
<p>La nueva regla ha reemplazado nombres de archivo explícitos con cosas
en <code>{curly brackets}</code>, específicamente <code>{output}</code>
(pero también podría haber sido <code>{input}</code>…si eso tuviera un
valor y fuera útil).</p>
<div class="section level3">
<h3 id="input-y-output-son-marcadores-de-posición">
<code>{input}</code> y <code>{output}</code> son <strong>marcadores
de posición</strong>
<a class="anchor" aria-label="anchor" href="#input-y-output-son-marcadores-de-posici%C3%B3n"></a>
</h3>
<p>Los marcadores de posición se utilizan en la sección
<code>shell</code> de una regla, y Snakemake los reemplazará con los
valores apropiados - <code>{input}</code> con el nombre completo del
archivo de entrada, y <code>{output}</code> con el nombre completo del
archivo de salida - antes de ejecutar el comando.</p>
<p><code>{resources}</code> también es un marcador de posición, y
podemos acceder a un elemento con nombre del <code>{resources}</code>
con la notación <code>{resources.runtime}</code> (por ejemplo).</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Puntos Clave</h3>
<div class="callout-content">
<ul>
<li>“Las reglas de Snakemake se hacen más genéricas con marcadores de
posición”</li>
<li>“Los marcadores de posición en la parte shell de la regla se
sustituyen por valores basados en los comodines elegidos”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-04-snakemake_and_mpi"><p>Content from <a href="04-snakemake_and_mpi.html">Aplicaciones MPI y Snakemake</a></p>
<hr>
<p>Última actualización: 2024-11-25 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/04-snakemake_and_mpi.md" class="external-link">Mejora esta página <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Tiempo estimado: <i aria-hidden="true" data-feather="clock"></i> 50 minutos</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Mostrar todas las soluciones " data-collapse="Cerrar todas las soluciones "> Mostrar todas las soluciones <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Hoja de ruta</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Preguntas</h3>
<ul>
<li>“¿Cómo puedo ejecutar una aplicación MPI a través de Snakemake en el
cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objetivos</h3>
<ul>
<li>“Define reglas para ejecutar localmente y en el clúster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Ahora es el momento de volver a nuestro flujo de trabajo real.
Podemos ejecutar un comando en el cluster, pero ¿qué pasa con la
ejecución de la aplicación MPI que nos interesa? Nuestra aplicación se
llama <code>amdahl</code> y está disponible como módulo de entorno.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>Localiza y carga el módulo <code>amdahl</code> y luego
<em>reemplaza</em> nuestra regla <code>hostname_remote</code> con una
versión que ejecute <code>amdahl</code>. (No te preocupes por el MPI
paralelo todavía, ejecútalo con una sola CPU,
<code>mpiexec -n 1 amdahl</code>).</p>
<p>¿Se ejecuta correctamente la regla? Si no es así, revise los archivos
de registro para averiguar por qué</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Mostrar la solución </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">module</span> spider amdahl</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">module</span> load amdahl</span></code></pre>
</div>
<p>localizará y cargará el módulo <code>amdahl</code>. Podemos entonces
actualizar/reemplazar nuestra regla para ejecutar la aplicación
<code>amdahl</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Sin embargo, cuando intentamos ejecutar la regla obtenemos un error
(a menos que ya tengas una versión diferente de <code>amdahl</code>
disponible en tu ruta). Snakemake informa de la ubicación de los logs y
si miramos dentro podemos (eventualmente) encontrar</p>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>...
mpiexec -n 1 amdahl &gt; amdahl_run.txt
--------------------------------------------------------------------------
mpiexec was unable to find the specified executable file, and therefore
did not launch the job.  This error was first reported for process
rank 0; it may have occurred for other processes as well.

NOTE: A common cause for this error is misspelling a mpiexec command
      line parameter option (remember that mpiexec interprets the first
      unrecognized command line token as the executable).

Node:       tmpnode1
Executable: amdahl
--------------------------------------------------------------------------
...</code></pre>
</div>
<p>Así que, aunque cargamos el módulo antes de ejecutar el flujo de
trabajo, nuestra regla Snakemake no encontró el ejecutable. Esto se debe
a que la regla de Snakemake se está ejecutando en un <em>entorno de
ejecución</em> limpio, y tenemos que decirle de alguna manera que cargue
el módulo de entorno necesario antes de intentar ejecutar la regla.</p>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="snakemake-y-módulos-de-entorno">Snakemake y módulos de entorno<a class="anchor" aria-label="anchor" href="#snakemake-y-m%C3%B3dulos-de-entorno"></a>
</h2>
<hr class="half-width">
<p>Nuestra aplicación se llama <code>amdahl</code> y está disponible en
el sistema a través de un módulo de entorno, por lo que necesitamos
decirle a Snakemake que cargue el módulo antes de que intente ejecutar
la regla. Snakemake es consciente de los módulos de entorno, y estos
pueden ser especificados a través de (otra) opción:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>      <span class="co">"mpi4py"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    shell:</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Sin embargo, añadir estas líneas no es suficiente para que la regla
se ejecute. No sólo tienes que decirle a Snakemake qué módulos cargar,
sino que también tienes que decirle que use módulos de entorno en
general (ya que se considera que el uso de módulos de entorno hace que
tu entorno de ejecución sea menos reproducible, ya que los módulos
disponibles pueden diferir de un cluster a otro). Esto requiere que le
des a Snakemake una opción adicional</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile <span class="at">--use-envmodules</span> amdahl_run</span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>Utilizaremos módulos de entorno durante el resto del tutorial, así
que conviértalo en una opción predeterminada de nuestro perfil
(estableciendo su valor en <code>True</code>)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Mostrar la solución </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Actualiza el perfil de nuestro clúster a</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="fu">use-envmodules</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code></pre>
</div>
<p>Si quieres probarlo, tienes que borrar el archivo de salida de la
regla y volver a ejecutar Snakemake.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="snakemake-y-mpi">Snakemake y MPI<a class="anchor" aria-label="anchor" href="#snakemake-y-mpi"></a>
</h2>
<hr class="half-width">
<p>En realidad no hemos ejecutado una aplicación MPI en la última
sección, ya que sólo lo hemos hecho en un núcleo. ¿Cómo solicitamos que
se ejecute en varios núcleos para una única regla?</p>
<p>Snakemake tiene soporte general para MPI, pero el único ejecutor que
actualmente soporta explícitamente MPI es el ejecutor Slurm (¡por suerte
para nosotros!). Si volvemos a mirar nuestra tabla de traducción de
Slurm a Snakemake nos daremos cuenta de que las opciones relevantes
aparecen cerca de la parte inferior:</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="15%">
<col width="65%">
</colgroup>
<thead><tr class="header">
<th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr>
<tr class="odd">
<td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr>
<tr class="even">
<td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr>
</tbody>
</table>
<p>El que nos interesa es <code>tasks</code> ya que sólo vamos a
aumentar el número de rangos. Podemos definirlos en una sección
<code>resources</code> de nuestra regla y referirnos a ellos usando
marcadores de posición:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    resources:</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">'mpiexec'</span>,</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>      tasks<span class="op">=</span><span class="dv">2</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    shell:</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Ha funcionado, pero ahora tenemos un pequeño problema. Queremos hacer
esto para algunos valores diferentes de <code>tasks</code> que
significaría que necesitaríamos un archivo de salida diferente para cada
ejecución. Sería genial si de alguna manera podemos indicar en el
<code>output</code> el valor que queremos utilizar para
<code>tasks</code> … y que Snakemake lo recoja.</p>
<p>Podríamos utilizar un <em>wildcard</em> en el <code>output</code>
para permitirnos definir el <code>tasks</code> que deseamos utilizar. La
sintaxis de este comodín es la siguiente</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span></code></pre>
</div>
<p>donde <code>parallel_tasks</code> es nuestro comodín.</p>
<div id="comodines" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="comodines" class="callout-inner">
<h3 class="callout-title">Comodines</h3>
<div class="callout-content">
<p>Los comodines se utilizan en las líneas <code>input</code> y
<code>output</code> de la regla para representar partes de nombres de
archivo. Al igual que el patrón <code>*</code> del intérprete de
comandos, el comodín puede sustituir a cualquier texto para formar el
nombre de archivo deseado. Al igual que con el nombre de sus reglas,
puede elegir cualquier nombre que desee para sus comodines, así que aquí
hemos utilizado <code>parallel_tasks</code>. El uso de los mismos
comodines en la entrada y la salida es lo que le dice a Snakemake cómo
hacer coincidir los archivos de entrada con los archivos de salida.</p>
<p>Si dos reglas usan un comodín con el mismo nombre entonces Snakemake
las tratará como entidades diferentes - las reglas en Snakemake son
autocontenidas de esta manera.</p>
<p>En la línea <code>shell</code> puede hacer referencia al comodín con
<code>{wildcards.parallel_tasks}</code></p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="orden-de-operaciones-de-snakemake">Orden de operaciones de Snakemake<a class="anchor" aria-label="anchor" href="#orden-de-operaciones-de-snakemake"></a>
</h2>
<hr class="half-width">
<p>Sólo estamos empezando con algunas reglas simples, pero vale la pena
pensar en lo que Snakemake está haciendo exactamente cuando se ejecuta.
Hay tres fases distintas:</p>
<ol style="list-style-type: decimal">
<li>Prepara la ejecución:
<ol style="list-style-type: decimal">
<li>Lee todas las definiciones de reglas del archivo Snakefile</li>
</ol>
</li>
<li>Planea qué hacer:
<ol style="list-style-type: decimal">
<li>Ve qué fichero(s) le estás pidiendo que haga</li>
<li>Busca una regla coincidente mirando las <code>output</code>s de
todas las reglas que conoce</li>
<li>Rellena los comodines para calcular el <code>input</code> de esta
regla</li>
<li>Comprueba que este archivo de entrada (si es necesario) está
disponible</li>
</ol>
</li>
<li>Ejecuta los pasos:
<ol style="list-style-type: decimal">
<li>Crea el directorio para el fichero de salida, si es necesario</li>
<li>Elimina el archivo de salida antiguo si ya está ahí</li>
<li>Sólo entonces, ejecuta el comando de shell con los marcadores de
posición sustituidos</li>
<li>Comprueba que el comando se ejecuta sin errores <em>y</em> crea el
nuevo archivo de salida según lo esperado</li>
</ol>
</li>
</ol>
<div id="modo-de-ejecución-en-seco--n" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="modo-de-ejecución-en-seco--n" class="callout-inner">
<h3 class="callout-title">Modo de ejecución en seco
(<code>-n</code>)</h3>
<div class="callout-content">
<p>A menudo es útil ejecutar sólo las dos primeras fases, de modo que
Snakemake planificará los trabajos a ejecutar, y los imprimirá en la
pantalla, pero nunca los ejecutará realmente. Esto se hace con la
bandera <code>-n</code>, eg:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="op">&gt;</span> $ <span class="ex">snakemake</span> <span class="at">-n</span> ...</span></code></pre>
</div>
</div>
</div>
</div>
<p>La cantidad de comprobaciones puede parecer pedante ahora mismo, pero
a medida que el flujo de trabajo gane más pasos esto nos resultará
realmente muy útil.</p>
</section><section><h2 class="section-heading" id="usando-comodines-en-nuestra-regla">Usando comodines en nuestra regla<a class="anchor" aria-label="anchor" href="#usando-comodines-en-nuestra-regla"></a>
</h2>
<hr class="half-width">
<p>Nos gustaría utilizar un comodín en <code>output</code> para poder
definir el número de <code>tasks</code> que deseamos utilizar.
Basándonos en lo que hemos visto hasta ahora, se podría imaginar que
esto podría tener el siguiente aspecto</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    resources:</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>      tasks<span class="op">=</span><span class="st">"</span><span class="sc">{parallel_tasks}</span><span class="st">"</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    shell:</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>pero hay dos problemas con esto:</p>
<ul>
<li>La única forma de que Snakemake conozca el valor del comodín es que
el usuario solicite explícitamente un archivo de salida concreto (en
lugar de llamar a la regla):</li>
</ul>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>  <span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile amdahl_run_2.txt</span></code></pre>
</div>
<p>Esto es perfectamente válido, ya que Snakemake puede averiguar que
tiene una regla que puede coincidir con ese nombre de archivo.</p>
<ul>
<li>
<p>El mayor problema es que incluso haciendo eso no funciona, parece
que no podemos usar un comodín para <code>tasks</code>:</p>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>WorkflowError:
SLURM job submission failed. The error message was sbatch:
error: Invalid numeric value "{parallel_tasks}" for --ntasks.</code></pre>
</div>
</li>
</ul>
<p>Por desgracia para nosotros, no hay forma directa de acceder a los
comodines de <code>tasks</code>. La razón de esto es que Snakemake
intenta utilizar el valor de <code>tasks</code> durante su etapa de
inicialización, que es antes de que sepamos el valor del comodín.
Necesitamos aplazar la determinación de <code>tasks</code> para más
adelante. Esto se puede conseguir especificando una función de entrada
en lugar de un valor para este escenario. La solución entonces es
escribir una función de un solo uso para manipular Snakemake para que
haga esto por nosotros. Dado que la función es específicamente para la
regla, podemos utilizar una función de una sola línea sin nombre. Este
tipo de funciones se llaman funciones anónimas o funciones lamdba (ambas
significan lo mismo), y son una característica de Python (y otros
lenguajes de programación).</p>
<p>Para definir una función lambda en python, la sintaxis general es la
siguiente:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">lambda</span> x: x <span class="op">+</span> <span class="dv">54</span></span></code></pre>
</div>
<p>Dado que nuestra función <em>puede</em> tomar los comodines como
argumentos, podemos utilizarla para establecer el valor de
<code>tasks</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    resources:</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>    shell:</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Ahora tenemos una regla que puede utilizarse para generar la salida
de ejecuciones de un número arbitrario de tareas paralelas.</p>
<div id="comentarios-en-snakefiles" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="comentarios-en-snakefiles" class="callout-inner">
<h3 class="callout-title">Comentarios en Snakefiles</h3>
<div class="callout-content">
<p>En el código anterior, la línea que comienza <code>#</code> es una
línea de comentario. Esperemos que ya tengas el hábito de añadir
comentarios a tus propios scripts. Los buenos comentarios hacen que
cualquier script sea más legible, y esto es igual de cierto con los
Snakefiles.</p>
</div>
</div>
</div>
<p>Dado que nuestra regla es ahora capaz de generar un número arbitrario
de ficheros de salida las cosas podrían llenarse mucho en nuestro
directorio actual. Probablemente sea mejor entonces poner las
ejecuciones en una carpeta separada para mantener las cosas ordenadas.
Podemos añadir la carpeta directamente a nuestro <code>output</code> y
Snakemake se encargará de crear el directorio por nosotros:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    output: <span class="st">"runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    resources:</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    shell:</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>Crea un fichero de salida (en la carpeta <code>runs</code>) para el
caso en que tengamos 6 tareas paralelas</p>
<p>(SUGERENCIA: Recuerde que Snakemake tiene que ser capaz de hacer
coincidir el archivo solicitado con el <code>output</code> de una
regla)</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Mostrar la solución </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile runs/amdahl_run_6.txt</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Otra cosa sobre nuestra aplicación <code>amdahl</code> es que en
última instancia queremos procesar la salida para generar nuestro
gráfico de escala. La salida en este momento es útil para la lectura,
pero hace que el procesamiento sea más difícil.<code>amdahl</code> tiene
una opción que realmente hace esto más fácil para nosotros. Para ver las
opciones de <code>amdahl</code> podemos utilizar</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ module load amdahl</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ amdahl <span class="at">--help</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>usage: amdahl [-h] [-p [PARALLEL_PROPORTION]] [-w [WORK_SECONDS]] [-t] [-e]

options:
  -h, --help            show this help message and exit
  -p [PARALLEL_PROPORTION], --parallel-proportion [PARALLEL_PROPORTION]
                        Parallel proportion should be a float between 0 and 1
  -w [WORK_SECONDS], --work-seconds [WORK_SECONDS]
                        Total seconds of workload, should be an integer greater than 0
  -t, --terse           Enable terse output
  -e, --exact           Disable random jitter</code></pre>
</div>
<p>La opción que buscamos es <code>--terse</code>, que hará que
<code>amdahl</code> imprima la salida en un formato mucho más fácil de
procesar, JSON. El formato JSON en un archivo normalmente utiliza la
extensión de archivo <code>.json</code> así que vamos a añadir esa
opción a nuestro comando <code>shell</code> <em>y</em> cambiar el
formato de archivo de la <code>output</code> para que coincida con
nuestro nuevo comando:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    output: <span class="st">"runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.json"</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    resources:</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>    shell:</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl --terse &gt; {output}"</span></span></code></pre>
</div>
<p>Había otro parámetro para <code>amdahl</code> que me llamó la
atención. <code>amdahl</code> tiene una opción
<code>--parallel-proportion</code> (o <code>-p</code>) que nos puede
interesar cambiar, ya que cambia el comportamiento del código, y por
tanto tiene un impacto en los valores que obtenemos en nuestros
resultados. Vamos a añadir otra capa de directorio a nuestro formato de
salida para reflejar una elección particular para este valor. Podemos
utilizar un comodín para no tener que elegir el valor de inmediato:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.json"</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    resources:</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>    shell:</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl --terse -p {wildcards.parallel_proportion} &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>Crea un fichero de salida para un valor de <code>-p</code> de 0.999
(el valor por defecto es 0.8) para el caso en que tengamos 6 tareas
paralelas.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Mostrar la solución </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile p_0.999/runs/amdahl_run_6.json</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Puntos Clave</h3>
<div class="callout-content">
<ul>
<li>“Snakemake elige la regla apropiada mediante la sustitución de
comodines de tal manera que la salida coincide con el objetivo”</li>
<li>“Snakemake comprueba varias condiciones de error y se detendrá si ve
un problema”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-05-chaining_rules"><p>Content from <a href="05-chaining_rules.html">Encadenamiento de reglas</a></p>
<hr>
<p>Última actualización: 2024-11-25 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/05-chaining_rules.md" class="external-link">Mejora esta página <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Tiempo estimado: <i aria-hidden="true" data-feather="clock"></i> 70 minutos</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Mostrar todas las soluciones " data-collapse="Cerrar todas las soluciones "> Mostrar todas las soluciones <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Hoja de ruta</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Preguntas</h3>
<ul>
<li>“¿Cómo combino reglas en un flujo de trabajo?”</li>
<li>“¿Cómo hago una regla con múltiples entradas y salidas?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objetivos</h3>
<ul>
<li>“”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="una-cadena-de-múltiples-reglas">Una cadena de múltiples reglas<a class="anchor" aria-label="anchor" href="#una-cadena-de-m%C3%BAltiples-reglas"></a>
</h2>
<hr class="half-width">
<p>Ahora tenemos una regla que puede generar una salida para cualquier
valor de <code>-p</code> y cualquier número de tareas, sólo tenemos que
llamar a Snakemake con los parámetros que queremos:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile p_0.999/runs/amdahl_run_6.json</span></code></pre>
</div>
<p>Aunque eso no es exactamente conveniente, para generar un conjunto de
datos completo tenemos que ejecutar Snakemake muchas veces con
diferentes objetivos de archivos de salida. En lugar de eso, vamos a
crear una regla que puede generar los archivos para nosotros.</p>
<p>Encadenar reglas en Snakemake es cuestión de elegir patrones de
nombres de archivos que conecten las reglas. Hay algo de arte en ello -
la mayoría de las veces hay varias opciones que funcionarán:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:  <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_6.json"</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>La nueva regla no está haciendo ningún trabajo, sólo se está
asegurando de que creamos el archivo que queremos. No vale la pena
ejecutarla en el cluster. ¿Cómo asegurarse de que se ejecuta sólo en el
nodo de inicio de sesión?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Mostrar la solución </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>Necesitamos añadir la nueva regla a nuestro
<code>localrules</code>:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>localrules: hostname_login, generate_run_files</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Ahora vamos a ejecutar la nueva regla (recuerda que tenemos que
solicitar el archivo de salida por su nombre ya que <code>output</code>
en nuestra regla contiene un patrón comodín):</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">--profile</span> cluster_profile/ p_0.999_runs.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">SALIDA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Using profile cluster_profile/ for setting default command line arguments.
Building DAG of jobs...
Retrieving input from storage.
Using shell: /cvmfs/software.eessi.io/versions/2023.06/compat/linux/x86_64/bin/bash
Provided remote nodes: 3
Job stats:
job                   count
------------------  -------
amdahl_run                1
generate_run_files        1
total                     2

Select jobs to execute...
Execute 1 jobs...

[Tue Jan 30 17:39:29 2024]
rule amdahl_run:
    output: p_0.999/runs/amdahl_run_6.json
    jobid: 1
    reason: Missing output files: p_0.999/runs/amdahl_run_6.json
    wildcards: parallel_proportion=0.999, parallel_tasks=6
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954,
               tmpdir=&lt;TBD&gt;, mem_mb_per_cpu=3600, runtime=2, mpi=mpiexec, tasks=6

mpiexec -n 6 amdahl --terse -p 0.999 &gt; p_0.999/runs/amdahl_run_6.json
No SLURM account given, trying to guess.
Guessed SLURM account: def-users
Job 1 has been submitted with SLURM jobid 342 (log: /home/ocaisa/.snakemake/slurm_logs/rule_amdahl_run/342.log).
[Tue Jan 30 17:47:31 2024]
Finished job 1.
1 of 2 steps (50%) done
Select jobs to execute...
Execute 1 jobs...

[Tue Jan 30 17:47:31 2024]
localrule generate_run_files:
    input: p_0.999/runs/amdahl_run_6.json
    output: p_0.999_runs.txt
    jobid: 0
    reason: Missing output files: p_0.999_runs.txt;
            Input files updated by another job: p_0.999/runs/amdahl_run_6.json
    wildcards: parallel_proportion=0.999
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954,
               tmpdir=/tmp, mem_mb_per_cpu=3600, runtime=2

echo p_0.999/runs/amdahl_run_6.json done &gt; p_0.999_runs.txt
[Tue Jan 30 17:47:31 2024]
Finished job 0.
2 of 2 steps (100%) done
Complete log: .snakemake/log/2024-01-30T173929.781106.snakemake.log</code></pre>
</div>
<p>Mira los mensajes de registro que Snakemake imprime en la terminal.
¿Qué ha ocurrido aquí?</p>
<ol style="list-style-type: decimal">
<li>Snakemake busca una regla para hacer
<code>p_0.999_runs.txt</code>
</li>
<li>Determina que “generate_run_files” puede hacer esto si
<code>parallel_proportion=0.999</code>
</li>
<li>Por lo tanto, ve que la entrada necesaria es
<code>p_0.999/runs/amdahl_run_6.json</code>
</li>
<li>Snakemake busca una regla para hacer
<code>p_0.999/runs/amdahl_run_6.json</code>
</li>
<li>Determina que “amdahl_run” puede hacer esto si
<code>parallel_proportion=0.999</code> y
<code>parallel_tasks=6</code>
</li>
<li>Ahora que Snakemake ha alcanzado un archivo de entrada disponible
(en este caso, no se requiere ningún archivo de entrada), ejecuta ambos
pasos para obtener la salida final</li>
</ol>
<p>Así, en pocas palabras, es como construimos flujos de trabajo en
Snakemake.</p>
<ol style="list-style-type: decimal">
<li>Definir reglas para todos los pasos de procesamiento</li>
<li>Elija <code>input</code> y <code>output</code> patrones de
nomenclatura que permitan a Snakemake vincular las reglas</li>
<li>Indicar a Snakemake que genere los archivos de salida finales</li>
</ol>
<p>Si usted está acostumbrado a escribir scripts regulares esto toma un
poco de tiempo para acostumbrarse. En lugar de enumerar los pasos en
orden de ejecución, siempre se está <strong>trabajando hacia
atrás</strong> desde el resultado final deseado. El orden de las
operaciones viene determinado por la aplicación de las reglas de
concordancia de patrones a los nombres de archivo, no por el orden de
las reglas en el archivo Snakefile.</p>
<div id="salidas-primero" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="salidas-primero" class="callout-inner">
<h3 class="callout-title">¿Salidas primero?</h3>
<div class="callout-content">
<p>El enfoque de Snakemake de trabajar hacia atrás desde la salida
deseada para determinar el flujo de trabajo es la razón por la que
estamos poniendo las líneas <code>output</code> primero en todas
nuestras reglas - ¡para recordarnos que esto es lo que Snakemake mira
primero!</p>
<p>Muchos usuarios de Snakemake, y de hecho la documentación oficial,
prefieren tener el <code>input</code> primero, por lo que en la práctica
se debe utilizar cualquier orden que tenga sentido para usted.</p>
</div>
</div>
</div>
<div id="log-salidas-en-snakemake" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="log-salidas-en-snakemake" class="callout-inner">
<h3 class="callout-title">
<code>log</code> salidas en Snakemake</h3>
<div class="callout-content">
<p>Snakemake tiene un campo de regla dedicado para las salidas que son
<a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#log-files" class="external-link">archivos
de registro</a>, y estos son tratados en su mayoría como salidas
regulares, excepto que los archivos de registro no se eliminan si el
trabajo produce un error. Esto significa que usted puede mirar el
registro para ayudar a diagnosticar el error. En un flujo de trabajo
real esto puede ser muy útil, pero en términos de aprendizaje de los
fundamentos de Snakemake nos quedaremos con los campos regulares
<code>input</code> y <code>output</code> aquí.</p>
</div>
</div>
</div>
<div id="los-errores-son-normales" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="los-errores-son-normales" class="callout-inner">
<h3 class="callout-title">Los errores son normales</h3>
<div class="callout-content">
<p>No te desanimes si ves errores cuando pruebes por primera vez tus
nuevos pipelines de Snakemake. Hay muchas cosas que pueden salir mal al
escribir un nuevo flujo de trabajo, y normalmente necesitarás varias
iteraciones para hacer las cosas bien. Una ventaja del enfoque de
Snakemake en comparación con los scripts regulares es que Snakemake
falla rápidamente cuando hay un problema, en lugar de seguir adelante y
potencialmente ejecutar cálculos basura sobre datos parciales o
corruptos. Otra ventaja es que cuando un paso falla, podemos reanudarlo
con seguridad desde donde lo dejamos.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Puntos Clave</h3>
<div class="callout-content">
<ul>
<li>“Snakemake enlaza reglas buscando iterativamente reglas que tengan
entradas faltantes”</li>
<li>“Las reglas pueden tener múltiples entradas y/o salidas con
nombre”</li>
<li>“Si un comando del shell no produce una salida esperada entonces
Snakemake lo considerará como un fallo”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-06-expansion"><p>Content from <a href="06-expansion.html">Procesamiento de listas de entradas</a></p>
<hr>
<p>Última actualización: 2024-11-25 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/06-expansion.md" class="external-link">Mejora esta página <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Tiempo estimado: <i aria-hidden="true" data-feather="clock"></i> 80 minutos</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Mostrar todas las soluciones " data-collapse="Cerrar todas las soluciones "> Mostrar todas las soluciones <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Hoja de ruta</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Preguntas</h3>
<ul>
<li>“¿Cómo puedo procesar varios archivos a la vez?”</li>
<li>“¿Cómo combino varios archivos?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objetivos</h3>
<ul>
<li>“Usa Snakemake para procesar todas nuestras muestras a la vez”</li>
<li>“Haz un gráfico de escalabilidad que agrupe nuestros
resultados”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Hemos creado una regla que puede generar un único archivo de salida,
pero no vamos a crear varias reglas para cada archivo de salida.
Queremos generar todos los archivos de ejecución con una sola regla si
pudiéramos, bueno Snakemake puede efectivamente tomar una lista de
archivos de entrada:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="bu">input</span>:  <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_2.json"</span>, <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_6.json"</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    shell:</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<p>Eso está muy bien, pero no queremos tener que listar todos los
archivos que nos interesan individualmente. ¿Cómo podemos hacerlo?</p>
<section><h2 class="section-heading" id="definición-de-una-lista-de-muestras-a-procesar">Definición de una lista de muestras a procesar<a class="anchor" aria-label="anchor" href="#definici%C3%B3n-de-una-lista-de-muestras-a-procesar"></a>
</h2>
<hr class="half-width">
<p>Para ello, podemos definir algunas listas como <strong>variables
globales</strong> de Snakemake.</p>
<p>Las variables globales deben añadirse antes de las reglas en el
Snakefile.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Task sizes we wish to run</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>NTASK_SIZES <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</span></code></pre>
</div>
<ul>
<li>A diferencia de lo que ocurre con las variables en los scripts de
shell, podemos poner espacios alrededor del signo <code>=</code>, pero
no son obligatorios.</li>
<li>Las listas de cadenas entrecomilladas van entre corchetes y
separadas por comas. Si sabes algo de Python reconocerás esto como
sintaxis de listas de Python.</li>
<li>Una buena convención es utilizar nombres en mayúsculas para estas
variables, pero no es obligatorio.</li>
<li>Aunque éstas se denominan variables, en realidad no se pueden
cambiar los valores una vez que el flujo de trabajo se está ejecutando,
por lo que las listas definidas de esta manera son más como
constantes.</li>
</ul></section><section><h2 class="section-heading" id="usando-una-regla-de-snakemake-para-definir-un-lote-de-salidas">Usando una regla de Snakemake para definir un lote de salidas<a class="anchor" aria-label="anchor" href="#usando-una-regla-de-snakemake-para-definir-un-lote-de-salidas"></a>
</h2>
<hr class="half-width">
<p>Ahora vamos a actualizar nuestro Snakefile para aprovechar la nueva
variable global y crear una lista de archivos:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    shell:</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<p>La función <code>expand(...)</code> de esta regla genera una lista de
nombres de archivo, tomando como plantilla lo primero que aparece entre
paréntesis y sustituyendo <code>{count}</code> por todos los
<code>NTASK_SIZES</code>. Dado que hay 5 elementos en la lista, esto
producirá 5 archivos que queremos hacer. Tenga en cuenta que tuvimos que
proteger nuestro comodín en un segundo conjunto de paréntesis para que
no fuera interpretado como algo que necesitaba ser expandido.</p>
<p>En nuestro caso actual seguimos dependiendo del nombre de fichero
para definir el valor del comodín <code>parallel_proportion</code>, por
lo que no podemos llamar a la regla directamente, seguimos necesitando
solicitar un fichero específico:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.999_runs.txt</span></code></pre>
</div>
<p>Si no especifica un nombre de regla de destino o cualquier nombre de
archivo en la línea de comandos cuando se ejecuta Snakemake, el valor
predeterminado es utilizar ** la primera regla ** en el Snakefile como
el objetivo.</p>
<div id="reglas-como-destinos" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="reglas-como-destinos" class="callout-inner">
<h3 class="callout-title">Reglas como destinos</h3>
<div class="callout-content">
<p>Dar el nombre de una regla a Snakemake en la línea de comandos sólo
funciona cuando esa regla tiene <em>sin comodines</em> en las salidas,
porque Snakemake no tiene manera de saber cuáles podrían ser los
comodines deseados. Verá el error “Las reglas de destino no pueden
contener comodines” Esto también puede ocurrir cuando no se proporciona
ningún objetivo explícito en la línea de comandos, y Snakemake intenta
ejecutar la primera regla definida en el archivo Snakefile.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="reglas-que-combinan-varias-entradas">Reglas que combinan varias entradas<a class="anchor" aria-label="anchor" href="#reglas-que-combinan-varias-entradas"></a>
</h2>
<hr class="half-width">
<p>Nuestra regla <code>generate_run_files</code> es una regla que toma
una lista de archivos de entrada. La longitud de esa lista no está
fijada por la regla, sino que puede cambiar en función de
<code>NTASK_SIZES</code>.</p>
<p>En nuestro flujo de trabajo el paso final es tomar todos los archivos
generados y combinarlos en un gráfico. Para ello, es posible que haya
oído que algunas personas utilizan una biblioteca de Python llamada
<code>matplotlib</code>. Está más allá del alcance de este tutorial
escribir el script de python para crear un gráfico final, así que te
proporcionamos el script como parte de esta lección. Puede descargarlo
con</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-O</span> https://ocaisa.github.io/hpc-workflows/files/plot_terse_amdahl_results.py</span></code></pre>
</div>
<p>El script <code>plot_terse_amdahl_results.py</code> necesita una
línea de comandos parecida a:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">python</span> plot_terse_amdahl_results.py <span class="at">--output</span> <span class="op">&lt;</span>output image filename<span class="op">&gt;</span> <span class="op">&lt;</span>1st input file<span class="op">&gt;</span> <span class="op">&lt;</span>2nd input file<span class="op">&gt;</span> ...</span></code></pre>
</div>
<p>Introduzcámoslo en nuestra regla <code>generate_run_files</code>:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    shell:</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        <span class="co">"python plot_terse_amdahl_results.py --output {output} {input}"</span></span></code></pre>
</div>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>Este script depende de <code>matplotlib</code>, ¿está disponible como
módulo de entorno? Añada este requisito a nuestra regla.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Mostrar la solución </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_scalability.jpg"</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>      <span class="co">"matplotlib"</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    shell:</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>        <span class="co">"python plot_terse_amdahl_results.py --output {output} {input}"</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>¡Por fin podemos generar un gráfico de escala! Ejecute el último
comando de Snakemake:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.999_scalability.jpg</span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>Genera el gráfico de escalabilidad para todos los valores de 1 a 10
núcleos.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Mostrar la solución </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>NTASK_SIZES <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Desafío</h3>
<div class="callout-content">
<p>Vuelva a ejecutar el flujo de trabajo para un valor <code>p</code> de
0.8</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Mostrar la solución </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.8_scalability.jpg</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="ronda-de-bonificación" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="ronda-de-bonificación" class="callout-inner">
<h3 class="callout-title">Ronda de bonificación</h3>
<div class="callout-content">
<p>Cree una regla final que pueda llamarse directamente y genere un
gráfico de escala para 3 valores diferentes de <code>p</code>.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Puntos Clave</h3>
<div class="callout-content">
<ul>
<li>“Utilice la función <code>expand()</code> para generar listas de
nombres de archivo que desee combinar”</li>
<li>“Cualquier <code>{input}</code> de una regla puede ser una lista de
longitud variable”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>Esta lección está sujeta al <a href="CODE_OF_CONDUCT.html">Código de Conducta</a></p>
        <p>

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/README.md" class="external-link">Editar en GitHub</a>

	
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CONTRIBUTING.md" class="external-link">Contribuir</a>
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/" class="external-link">Fuente</a></p>
				<p><a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CITATION.cff" class="external-link">Cita</a> | <a href="mailto:maintainers-hpc@lists.carpentries.org">Contacto</a> | <a href="https://carpentries.org/about/" class="external-link">Acerca de</a></p>
			</div>
			<div class="col-md-6">

        <p>Materiales bajo la <a href="LICENSE.html">CC-BY 4.0</a> por las autoras</p>

        <p>Plantilla compartida bajo <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> por <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Construido con <a href="https://github.com/carpentries/sandpaper/tree/0.16.10" class="external-link">sandpaper (0.16.10)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.7" class="external-link">pegboard (0.7.7)</a> y <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Volver al inicio"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Volver</span> al inicio
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "inLanguage": "es",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "HPC Carpentry, snakemake, workflows, hpc",
  "name": "Todo en una sola página",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "identifier": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "dateCreated": "2023-04-19",
  "dateModified": "2024-12-03",
  "datePublished": "2024-12-03"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

